name: build-ohos-arm64

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "binding.gyp"
      - "package.json"
      - ".github/workflows/build-ohos-arm64.yml"

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      TARGET_TRIPLE: aarch64-linux-ohos
      BUILD_DIR: ${{ github.workspace }}/build
      npm_config_arch: arm64
      npm_config_platform: linux
      npm_config_target_arch: arm64
      npm_config_target_platform: linux

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install build prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3 python3-pip xz-utils curl

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          check-latest: true

      - name: Setup OpenHarmony SDK
        uses: openharmony-rs/setup-ohos-sdk@v0.2
        with:
          version: 6.0

      - name: Configure OHOS toolchain environment
        run: |
          echo "OHOS_SDK_ROOT=$OHOS_BASE_SDK_HOME" >> "$GITHUB_ENV"
          echo "OHOS_SYSROOT=$OHOS_SDK_NATIVE/sysroot" >> "$GITHUB_ENV"
          echo "CFLAGS=--sysroot=$OHOS_SDK_NATIVE/sysroot --target=$TARGET_TRIPLE -fPIC" >> "$GITHUB_ENV"
          echo "CXXFLAGS=--sysroot=$OHOS_SDK_NATIVE/sysroot --target=$TARGET_TRIPLE -fPIC -std=c++20" >> "$GITHUB_ENV"
          echo "LDFLAGS=--sysroot=$OHOS_SDK_NATIVE/sysroot --target=$TARGET_TRIPLE -L$OHOS_SDK_NATIVE/sysroot/usr/lib/$TARGET_TRIPLE -lc++_shared -lunwind" >> "$GITHUB_ENV"
          echo "$OHOS_SDK_NATIVE/llvm/bin" >> "$GITHUB_PATH"
          echo "CC=clang" >> "$GITHUB_ENV"
          echo "CXX=clang++" >> "$GITHUB_ENV"
          echo "AR=llvm-ar" >> "$GITHUB_ENV"
          echo "NM=llvm-nm" >> "$GITHUB_ENV"
          echo "STRIP=llvm-strip" >> "$GITHUB_ENV"

      - name: Verify SDK layout
        run: |
          ls -R "$OHOS_SDK_NATIVE" | head -n 20

      - name: Install npm dependencies
        run: npm ci --ignore-scripts

      - name: Prepare gyp build
        run: npx node-gyp configure --arch=arm64 -- -DOS=linux

      - name: Build addon
        run: npx node-gyp build --arch=arm64 -- -DOS=linux

      - name: Inspect artifact
        run: |
          file "$BUILD_DIR/Release/spdlog.node"
          ls -al "$BUILD_DIR/Release"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: spdlog-ohos-arm64
          path: |
            build/Release/spdlog.node
            build/config.gypi

